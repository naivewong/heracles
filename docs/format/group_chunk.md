# Group Chunk Format

A group contains a set of time series and all the time series inside a gorup share the same timestamp column.  
And inside the group, we can random access the data points of the given starting timestamp.  
  
The following describes the format of a single chunks file, which is created in the `chunks/` directory of a block. The maximum size per segment file is 512MiB.  
  
Chunks in the files are referenced from the index by uint64 composed of in-file offset (lower 4 bytes) and segment sequence number (upper 4 bytes).

```
The group chunk disk format
┌────────────────────────────┐
│ magic(0x51705259) <4 byte> │
├────────────────────────────┤
│ ┌────────────────────────┐ │
│ │         Group 1        │ │
│ ├────────────────────────┤ │
│ │          ...           │ │
│ ├────────────────────────┤ │
│ │         Group N        │ │
│ └────────────────────────┘ │
└────────────────────────────┘
```
## Group chunk format on disk
```
Inside a group
┌────────────────────────────────────────────────────────────────────────────────────────┐
│                               len <uvarint>                                            │
├────────────────────────────────────────────────────────────────────────────────────────┤
│                       ┌────────────────────────────────────┐                           │
│                       │       #timestamp <uvarint>         │                           │
│                       ├────────────────────────────────────┤                           │
│                       │       #series <uvarint>            │                           │
│                       ├────────────────────────────────────┤                           │
│                       │       starting_time <varint>       │                           │
│                       ├────────────────────────────────────┤                           │
│                       │       interval <varint>            │                           │
│                       ├────────────────────────────────────┤                           │
│                       │       alignment length <1 byte>    │                           │
│                       ├────────────────────────────────────┤                           │
│                       │       diff_1 <varint>              │                           │
│                       ├────────────────────────────────────┤                           │
│                       │             ...                    │                           │
│                       ├────────────────────────────────────┤                           │
│                       │       diff_n <varint>              │                           │
│                       └────────────────────────────────────┘                           │
├────────────────────────────────────────────────────────────────────────────────────────┤
│┌──────────────────────────────────────────┬───────────────────────────────────────────┐│
││ meidan_1 <8 bytes>                       │ meidan_2 <8 bytes>                        ││
│├──────────────────────────────────┬───────┴───────────────┬───┬───────────────────────┤│
││ block offsets alignment <1 byte> │ block 1 offset <bits> │...│ block n offset <bits> ││
│├──────────────────────────────────┴───────────────────────┴───┴───────────────────────┤│
││ ┌──────────────────────────────────────────────────────────────────────────────────┐ ││
││ │ Block 1 tuple alignment <1 byte>                                                 │ ││
││ ├──────────────────────────────────────────────────────────────────────────────────┤ ││
││ │         ┌────────┬────────┬────────┬────────┬────────┬────────┬────────┬────────┐│ ││
││ │ tuple 1 │ value1 │ value2 │ value3 │ value4 │ value5 │ value6 │ value7 │ value8 ││ ││
││ │         └────────┴────────┴────────┴────────┴────────┴────────┴────────┴────────┘│ ││
││ │                . . .                                                             │ ││
││ │ tuple n <alignment bits>                                                         │ ││
││ └──────────────────────────────────────────────────────────────────────────────────┘ ││
││                  . . .                                                               ││
││ ┌──────────────────────────────────────────────────────────────────────────────────┐ ││
││ │ Block n                                                                          │ ││
││ └──────────────────────────────────────────────────────────────────────────────────┘ ││
│└──────────────────────────────────────────────────────────────────────────────────────┘│
│                                                                                        │
│  . . .                                                                                 │
│                                                                                        │
├────────────────────────────────────────────────────────────────────────────────────────┤
│                               CRC32 <4 bytes>                                          │
└────────────────────────────────────────────────────────────────────────────────────────┘
```
## Group chunk format in memory
Outside the memory group chunk, we will record  
* The starting timestamp of the group
* The first value of each time series
```
Inside a group, suppose tuple size = 4, suppose the group contains n series.
┌────────────────────────────┐
│ ┌────────────────────────┐ │
│ │      Time tuple 1      │ │
│ ├────────────────────────┤ │
│ │          ...           │ │
│ ├────────────────────────┤ │
│ │      Time tuple N      │ │
│ └────────────────────────┘ │
├────────────────────────────┤
│ ┌────────────────────────┐ │
│ │      Series slot 1     │ │
│ ├────────────────────────┤ │
│ │          ...           │ │
│ ├────────────────────────┤ │
│ │      Series slot n     │ │
│ └────────────────────────┘ │
└────────────────────────────┘

Inside a time tuple.
Delta is based on the starting timestamp.
┌────────────────────┬────────────────────┬───────┬────────────────────┬────────────────────┐
│ delta_t1  <varint> │ delta_t2  <varint> │ . . . │ delta_t8  <varint> │alignment <uvarint> │
├────────────────────┴────────────────────┴───────┴────────────────────┴────────────────────┤
│ ┌───────────────────────────────────────────────────────────────────────────────────────┐ │
│ │ pos_1 (the starting offset of next tuple in the series slot 1) <alignment bits>       │ │
│ ├───────────────────────────────────────────────────────────────────────────────────────┤ │
│ │                . . .                                                                  │ │
│ ├───────────────────────────────────────────────────────────────────────────────────────┤ │
│ │ pos_n (the starting offset of next tuple in the series slot n) <alignment bits>       │ │
│ └───────────────────────────────────────────────────────────────────────────────────────┘ │
└───────────────────────────────────────────────────────────────────────────────────────────┘

Inside a series slot.
The first value of each tuple is the XOR result based on the first value of the corresponding series.
The following values of each tuple are the XOR results based on the previous value.
┌───────────────────────────────────────────────┐
│         ┌────────┬────────┬────────┬────────┐ │
│ tuple 1 │ value1 │ value2 │  ...   │ value8 │ │
│         └────────┴────────┴────────┴────────┘ │
├───────────────────────────────────────────────┤
│                      . . .                    │
├───────────────────────────────────────────────┤
│         ┌────────┬────────┬────────┬────────┐ │
│ tuple n │ value1 │ value2 │  ...   │ value8 │ │
│         └────────┴────────┴────────┴────────┘ │
└───────────────────────────────────────────────┘
```